---
title: "ECON 1190: Econometrics 2:  \nSlides 2: Getting started in R"
author: "Claire Duquennois"

output:
  beamer_presentation: default
  pdf_document: default
  slidy_presentation: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=5, fig.height=2) 
library("lfe")
library("stargazer")
library(wooldridge)

```


# Starting up in R


## Setting up your account

- Make an account on R Studio Cloud (aka Posit Cloud)

- Join the course work space by clicking the link in the canvas announcement

- upgrade your account to a student account for $5/month to get access to more RAM

- If you want to follow along with the coding in class today:

    - Start the Slides2_Started_inR assignment
    
    - Open and download the Slides2_chunks.txt file from canvas



##  R Markdown

 - We're going to do most of our work using R Markdown.
 
 - Why it's nice
 
       - Run multiple lines of code at once.
 
       - But don't have to run all code at once.
 
       - Add comments between chunks of code.
 
       - Compile output into pretty documents.
       
All of my lecture slides and notes are made in R Markdown!

## R Markdown: Getting started

 - Create file: File -> New File -> R Markdown...


 ![]("images\Rmarkdown1.png")

## R Markdown: Getting started

- Give your file a title

- Set it to compile to PDF

- Click OK
       
   ![]("images\Rmarkdown2.png")
   
## R Markdown: The workspace

   ![]("images\Rmarkdown3.png")

     
##  R Markdown: The Console


When you run code, in the console you will see:
    
    - the lines that were run
    - called output 
    - errors and warnings

You can type commands directly into the console \textbf{BUT} these will not be saved

   ![]("images\Rmarkdown4.png"){width=60%}
   
   
##  R Markdown: Your R Markdown File

This is where the action is! 

This file is a combination of:

- Markdown text (in the white parts)

- R code in the chunks (the grey parts)

When you ``Knit'' an R markdown file, you will produce a PDF document (or HTML or WORD...) that combines your text, code and code output.


##  R Markdown: Your R Markdown File
   ![]("images\Rmarkdown5.png"){width=60%}

And when prompted, save your PDF file to your workspace
 
##  R Markdown: Your R Markdown File
 
Congrats! You now have a PDF document with the default Rmarkdown example code and text!

Let's move beyond the default...


##  R Markdown File Elements
 ![]("images\Rmarkdown6.png"){width=90%}

##  R Markdown: Edit the markdown text

- Edit the Markdown text

- Re-knit your document and see your changes

 ![]("images\Rmarkdown7.png"){width=90%}


##  R Markdown: Edit the R code

Why are we summarizing the data in the cars data set but plotting the data in the pressure data set?

Let's fix that. Replace the word pressure with cars in the `plot()` function and re-knit your document


 ![]("images\Rmarkdown8.png"){width=90%}

##  R Markdown: Edit the R code

Congrats! Your PDF file should now show a new scatterplot of the cars data.  


##  R Markdown: Code "chunks"

 - Always write code in ``grey'' regions called chunks     

 - Creating a new chunk
       
       - Green +C box
       
       - option-command-i (Mac)
       
       - control-alt-i (Windows)
       
 - the first line of the chunk, in brackets is the chunk header 
 
 
##  R Markdown: Chunk headers

The UNIQUE chunk name:

- the 1st element (before first comma)

- If you use the same name for multiple chunks your file will not knit

- Ex: try replacing \textit{r pressure} with \textit{r cars} in the third chunk: your file will not knit

##  R Markdown: Chunk headers


Other chunk options that determine how your code shows up in your document (separate multiple options with commas):

- `include = FALSE` prevents code and results from appearing in the finished file. R Markdown still runs the code in the chunk, and the results can be used by other chunks.

- `echo = FALSE` prevents code, but not the results from appearing in the finished file. This is useful to embed figures.

- `message = FALSE` prevents messages that are generated by code from appearing in the finished file.

- `warning = FALSE` prevents warnings that are generated by code from appearing in the finished file.

Notice: the line `knitr::opts_chunk$set(echo = TRUE)` is setting the default for all the chunks to have `echo=TRUE`.


##  R Markdown: Code "chunks"
 
 - Execute code
 
       - Green arrow in upper right of chunk.  
       
       - command-shift-enter (Mac) [click inside chunk first]
       
       - control-shift-enter (Windows) [click inside chunk first]
       
       - Let's run some code!

## R Code

Create a chunk and type the following: 

\tiny
```{r, echo = TRUE}
x <- 2 # Assign the value 2 to the variable x
y <- 3 # Assign the value 3 to the variable y
z <- x + y # Add x and y
z
```
\normalsize

- The operator "<-" is how we assign the value to a variable. The value could be a number but also a list, string, matrix, etc.
   
- To add comments, put a "#" before comment. Comments appear green. R ignores these when it executes the code. 
   
- R printed 5 under the chunk. If you perform an operation and don't store the result as a variable, R will print it.
    
- Note that the code and output was printed in the Console.

- The values you created x, y, z now appear in your Environment.


## R Packages

 - A package is a set of functions/commands which have already been programmed.
 - To use a package you must load it from the library:  use library() function. 
 
```{r library, echo=TRUE}
library(stats) #loading the stats package
```

 - If a package is not in the library it is not yet installed. To install packages use the install.packages() command.
 
```{r packages, echo=TRUE}
#install.packages("ggplot2")
```

 - We can now load ggplot2 from the library when we want to use it.


## Loading data

Let's load the `olympics_data.csv` data:

- this is already in the RStudio cloud workspace

- it is also on the course canvas page

- this is a csv (Comma Separated Vales) file, to load it we need the function `read.csv` 

\tiny
```{r loaddata, echo=TRUE}
olympics <- read.csv("olympics_data.csv")

View(olympics) #opens the data in the data viewer

head(olympics,5) #prints the first 5 rows of data in the console (or knitr doc)
```
\normalsize



## Data Management with Dplyr

You're going to be using a lot of data. Dplyr makes working with data less overwhelming.

 - Dplyr is a data management package.

 - Dplyr allows us to apply multiple transformations to our data at once using the pipe operator: %<%

 - First let's load the dplyr package (we installed it earlier) 
 
\tiny
```{r dplyr, echo=TRUE, warnings=FALSE}
# Load Dplyr
library(dplyr)
```

\normalsize


## Selecting Data

When working with a large data set, it can be helpful to select the columns you will use.

Create a new dataset `olympics2` that only contains the columns we will use (drops country_abbrev, continent, g8)
\tiny

```{r select, echo=TRUE}
olympics2<-olympics %>% select(country, year, type, gold, silver, bronze, population, gdp)
head(olympics2)
```
\normalsize


- First we write the data set name, then the pipe operator (%>%), and then the select() function.

- In the select() function I list the variables I want to keep (... there are other ways to do this)

- this smaller data is saved as `olympics2` in the environment

## Filtering Data

You may want to limit your data to certain rows.

Create a new dataset `us_olympics` that only contains observations for the United States, using the `filter` function

\tiny

```{r filter, echo=TRUE}
us_olympics<-olympics2 %>% filter(country == "United States")
head(us_olympics)
```
\normalsize


- First we write the data set name, then the pipe operator (%>%), and then the `filter()` function.

- The `filter()` function takes a logical statement. In this case country == "United States". `country` is the variable we are filtering on, == is a logical operator, "United States" is a value.

## Variable types

\textbf{String variable:}

\small
- Country is a string variable: to select rows we write "United States" in quotation marks

- Main logical operators: == (is equal to) and != (is not equal to)
  \normalsize


\textbf{Numeric variables:}

\small
  - Year is a numeric variable: no need for quotation marks.
  
  - With numeric variables we can use additional logical operators
  
    - < Less than and > Greater than    
    - <= Less than or equal to and >= Greater than or equal to
    - %in% is in a particular vector (more about vectors later
         
  \normalsize


\textbf{Factor variables:}

 - variable is a set of numeric codes 
 
 - the numeric value does not matter, it just defines a category



## Filtering Data



Filter the United States at Summer Olympics since 2010
\tiny

```{r, echo=TRUE}
uss10_olympics<-olympics2 %>% filter(country == "United States" & type == "summer" & year >= 2010)
head(uss10_olympics)
```

\normalsize



 - We can combine multiple conditions using the & operator.

 - If we want to use or, we can use | (that is a vertical line not a capital I)

## Filtering Data

Filter observations with more than 10 silver medals or more than 4 gold medals.
\tiny

```{r, echo=TRUE}
olympics_SG<-olympics2 %>% filter(silver > 10 | gold > 4)
head(olympics_SG)
```

\normalsize


## Filtering Data

Filter observations from Argentina, Colombia, Brazil, Mexico.




\tiny

```{r, echo=TRUE}
olympics_LA<-olympics2 %>% filter(country %in% c("Argentina", "Colombia", "Brazil", "Mexico"))
```

\normalsize


-  Use `%in%` operator

- `c( , , , )` defines a vector

- we are telling R to keep observations where the variable `country` is the same as one of the strings in the given vector

## Missing values

- Missing values in R are indicated with `NA`

- Being aware of missing values in a variable is important since they tend to mess things up. We'll talk more about this later.

We can filter on rows where none of the population values of a variable are missing.

\tiny
```{r, echo=TRUE}
olympics_nomiss <- olympics2 %>% filter(!is.na(population))
head(olympics_nomiss)
```
\normalsize




## Create New Variables

Create a new variable called total that is the sum of all medals 
\tiny
```{r, echo=TRUE}
#method 1: use the mutate function in dplyr
olympics2 <- olympics2 %>% mutate(total = gold + silver + bronze) 

#method 2: using base R
olympics2$total2<-olympics2$gold+olympics2$silver+olympics2$bronze 
head(olympics2)
```
\normalsize

 - I store my output using the same name. This overwrites the original data set. 
 
 - Here I use only a single = sign. This is not a logical statement but rather a formula.
 
 - to call a variable in base R: `dataset_name$variable_name`




## Summarize Data 
To summarize data, we combine group_by() and summarize().

Get the total count of medals by country and season for all years

\tiny
```{r, echo=TRUE, warnings=FALSE, message = FALSE}
olympics_totals<-olympics2 %>% group_by(country, type) %>% summarize(total_medals = sum(total))

head(olympics_totals)
```

\small

 - We divided the data into groups and got the sum of each group.
 - The groups are defined by country and season so we write group_by(country, type).
 - summarize took the sum of the variable total and stored it in a variable called total_medals.
 - Other `summarize` operations: mean(), median(), sd(), min(), max()...

## Multiple operations


Now let's put it all together. Calculate a country's  average score at the summer olympics.
\tiny
```{r, echo=TRUE}
olympics_sumavg<-olympics2 %>% filter(type == "summer")%>%
  group_by(country) %>%
  summarize(avg_total = mean(total)) 

head(olympics_sumavg)
```

\normalsize

This is the beauty of dplyr.




## GGplot2 

A great tool to visualize, and learn about, your data

First we will need to load ggplot
```{r}
# Install GGplot2
# install.packages("ggplot2")

# Load  GGplot2
library(ggplot2)
```


## Step 1: Prepare the data

Before working with ggplot, you need to prepare your data for graphing.


- Is there a relationship between population and medals in the summer olympics?

\tiny
```{r, echo=TRUE}
olympics_plot1<-olympics2 %>% filter(type == "summer" & !is.na(population))

head(olympics_plot1)
```

\normalsize


## Step 2: Understand your data

It is wise to  look at the summary statistics of variables. 


\tiny
```{r, echo=TRUE}
summary(olympics_plot1$population)
sd(olympics_plot1$population)
```
\normalsize



## Step 2: Understand your data

Histograms can be particularly informative to get a sense of your data. 

- Here I use a  simple command but could also use ggplot

Looks like there are some big outliers...

\tiny
```{r, echo=TRUE}

hist(olympics_plot1$population)
```
\normalsize




## Step 3: Build your figure


\tiny
```{r, echo=TRUE}
my_plot1<-ggplot(data = olympics_plot1, aes(x = population, y = total))+
  geom_point(size=6, shape=23)
my_plot1
```

\normalsize

## Step 5: Critiquing our figure

Not bad BUT...

- kind of ugly

- can't see much where the action is (bottom left)

- have multiple observations for each country. Maybe averages over this time period would be better? 

## Step 6: Improve your figure


\tiny
```{r, echo=TRUE}
olympics_plot2<-olympics2 %>%
  filter(type == "summer" & !is.na(population)& population<400)%>%
  group_by(country)%>% 
  mutate(total = gold + silver + bronze) %>%
  summarize(avg_total = mean(total), avg_pop=mean(population)) 

my_plot2<-ggplot(data = olympics_plot2, aes(x =avg_pop, y = avg_total))+
  geom_point(size=2,shape=23, color="magenta1")+ 
  labs(x = "Population in millions (mean)", y = "All medals (mean)")+
  theme_minimal()
my_plot2
```



## A more interesting figure



\tiny
```{r, echo=TRUE}
olympics_plot3<-olympics2 %>%
  filter(type == "summer" & !is.na(population)& !is.na(gdp))%>%
  group_by(country)%>% 
  mutate(total = gold + silver + bronze) %>%
  summarize(avg_total = mean(total), avg_pop=mean(population), avg_gdp=mean(gdp))%>%
  mutate(avg_total_cap=avg_total/avg_pop, avg_gdp_cap=avg_gdp/avg_pop)%>%
  filter(avg_pop>=1)

my_plot3<-ggplot(data = olympics_plot3, aes(x =avg_gdp_cap, y =avg_total_cap ))+
  geom_point(size=2,shape=23, color="magenta1")+ 
  labs(x = "?", y = "?")+
  theme_minimal()
my_plot3
```

## Top Hat question

How should I label the axes?

$\Rightarrow$ Top Hat


## GGplot basics

\small
 - Always prepare your data before making a graph. 
 
 - We start a ggplot with the ggplot() function, typically with two arguments:
    
    - data: this is the name of your dataset
    - aes: this controls how your data relates to the graph. 
      - x: the variable on the x-axis
      - y: the variable on the y-axis
                  
 -  ggplot() only creates the chart area. To add layers we use the + operator. Here we added a
 
  - geom_point() layer (the dots)

 - labs() layer (defines the axis labels)
 
 - the theme_minimal() layer (sets the background colors/format)
 
There are many (MANY!) options with ggplot with lots (LOTS!) of online example to help you make great figures

## Regressions in R

- Can use the `lm()` function

- for more advanced regressions we will be running use `felm()` which is part of the lfe package (same syntax)

\tiny
```{r, echo=TRUE}
reg<-felm(avg_total_cap~avg_gdp_cap, olympics_plot3)
summary(reg)
```
\normalsize


## Stargazer

Lets make the regression results more presentable. 

\tiny
```{r, echo=TRUE, results='asis'}
reg<-felm(avg_total_cap~avg_gdp_cap, olympics_plot3)
stargazer(reg, type = "latex",  header=FALSE)
```
\normalsize

## Stargazer


Stargazer is like the table version of ggplot. 

- It will help you generate nice presentable table
- has lots (LOTS!) of options to customize your presentation
- for the table to render you need to add the chunk option: `results='asis'` in the chunk header 
- you should specify output type "latex"
- there are lots of example online of how to format stargazer tables.
- you might need to install a latex editor (https://miktex.org/download)

## R resources for troubleshooting

Help function:

 - The help() function will bring up the documentation for a given function
 
 - Let's look at the documentation for rnorm
```{r}
#help(rnorm)
```

Web search:

  - Half of coding is knowing how to Google your questions.

  - \textbf{stackoverflow.com}: A particularly helpful website  

GGplot image web search:

  - Describe the kind of figure you want +ggplot and look at image results. Sometimes the code for the image is given
  
  - Lots of tutorial websites on ggplot visualizations



